/* MMM-GrafanaChart
 * This MagicMirrorÂ² module allows you to display a chart generated by grafana.
 *
 * By SvenSommer https://github.com/SvenSommer
 * MIT Licensed.
 */


Module.register("MMM-GrafanaChart", {
    // Default module config.
    defaults: {
        protocol: "http",
        height:"100%",
        width:"100%",
        refreshInterval: 900
    },

    // Define start sequence.
    start: function() {
        Log.info("Starting module: " + this.name);
        this.scheduleUpdate();
    },

    buildUrl: function() {
        var URL = "";
        URL += this.config.protocol + "://";
        URL += this.config.host + ":" + this.config.port;
        if (this.config.version == "6") {
            URL += "/d/" + this.config.id;
        } else{
            URL += "/dashboard-solo/db";
        }
        URL += "/" + this.config.dashboardname;
        URL += "?orgId=" + this.config.orgId;
        URL += "&panelId=" + this.config.panelId;
        if (this.config.version == "6") {
            URL += "&fullscreen&kiosk";
        }
        return URL;
    },

    // Override dom generator.
    getDom: function() {
        var iframe = document.createElement("IFRAME");
        iframe.style = "border:0"
        iframe.width = this.config.width;
        iframe.height = this.config.height;
        iframe.src = this.buildUrl();
        // this attribute is used to ensure MagicMirror doesn't throw away our updateDom(), because the DOM object is identical to the previous one
        iframe.setAttribute("timestamp", new Date().getTime());
        iframe.setAttribute("scrolling", "no");
        return iframe;
    },
    scheduleUpdate: function() {
        var self = this;
        setTimeout(function() {
            self.updateFrame();
        }, this.config.refreshInterval*1000);
    },
    updateFrame: function() {
        Log.info("attempting to update dom for iFrameReload");
        this.updateDom(1000);
        this.scheduleUpdate();
    }
});
